{% extends 'journal/base.html' %}

{% block title %}
    {% if object %}Edit Top Management Report{% else %}Create Top Management Report{% endif %} - BR Journal
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-crown text-warning"></i>
        {% if object %}Edit Top Management Report{% else %}Create Top Management Report{% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'journal:topman_report_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Reports
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <form method="post" novalidate id="topman-report-form">
            {% csrf_token %}
            
            <!-- Basic Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Report Information</h5>
                </div>
                <div class="card-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="fas fa-heading"></i> Report Title *
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger small">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Date Range -->
                    <div class="row">
                        <div class="col-md-6">
                            <label for="{{ form.week_start.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar"></i> Week Start *
                            </label>
                            {{ form.week_start }}
                            {% if form.week_start.errors %}
                                <div class="text-danger small">{{ form.week_start.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.week_end.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar"></i> Week End *
                            </label>
                            {{ form.week_end }}
                            {% if form.week_end.errors %}
                                <div class="text-danger small">{{ form.week_end.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Summary Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt"></i> Executive Summary</h5>
                </div>
                <div class="card-body">
                    <label for="{{ form.executive_summary.id_for_label }}" class="form-label">
                        Summary for Top Management
                    </label>
                    {{ form.executive_summary }}
                    <div class="form-text">Provide a high-level summary of key points, trends, and insights for executive review.</div>
                    {% if form.executive_summary.errors %}
                        <div class="text-danger small">{{ form.executive_summary.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Admin Added Items Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Admin Added Items</h5>
                    <p class="text-muted small mb-0">Add additional items directly for top management attention</p>
                </div>
                <div class="card-body">
                    <!-- Form errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <!-- Admin Highlights Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">
                                <i class="fas fa-star text-warning"></i> Admin Highlights
                            </label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAdminItem('admin_highlights')">
                                <i class="fas fa-plus"></i> Add Highlight
                            </button>
                        </div>
                        <div id="admin_highlights-container" class="dynamic-container">
                            <!-- Dynamic admin highlights will be added here -->
                        </div>
                        <div class="form-text">Key achievements and executive-level highlights</div>
                    </div>

                    <!-- Admin Challenges Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">
                                <i class="fas fa-exclamation-triangle text-danger"></i> Admin Challenges
                            </label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAdminItem('admin_challenges')">
                                <i class="fas fa-plus"></i> Add Challenge
                            </button>
                        </div>
                        <div id="admin_challenges-container" class="dynamic-container">
                            <!-- Dynamic admin challenges will be added here -->
                        </div>
                        <div class="form-text">Critical issues requiring executive attention</div>
                    </div>

                    <!-- Admin Strategies Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">
                                <i class="fas fa-lightbulb text-primary"></i> Admin Strategies
                            </label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAdminItem('admin_strategies')">
                                <i class="fas fa-plus"></i> Add Strategy
                            </button>
                        </div>
                        <div id="admin_strategies-container" class="dynamic-container">
                            <!-- Dynamic admin strategies will be added here -->
                        </div>
                        <div class="form-text">Strategic initiatives and action plans</div>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i>
                            {% if object %}Update Report{% else %}Create Report{% endif %}
                        </button>
                        <a href="{% url 'journal:topman_report_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        {% if object %}
                            <a href="{% url 'journal:topman_report_detail' object.pk %}" class="btn btn-outline-info">
                                <i class="fas fa-eye"></i> View Report
                            </a>
                            <a href="{% url 'journal:topman_tagging' %}?week_start={{ object.week_start|date:'Y-m-d' }}&week_end={{ object.week_end|date:'Y-m-d' }}" class="btn btn-outline-warning">
                                <i class="fas fa-tags"></i> Tag Items
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.dynamic-container {
    min-height: 50px;
}

.dynamic-item {
    margin-bottom: 15px;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.dynamic-item:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.dynamic-item textarea {
    border: none;
    background: transparent;
    resize: vertical;
    min-height: 38px;
    width: 100%;
}

.dynamic-item textarea:focus {
    background-color: white;
    border: 1px solid #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    border-radius: 4px;
}

.status-select {
    min-width: 130px;
    font-size: 0.875rem;
}

.remove-btn {
    opacity: 0.7;
    transition: opacity 0.2s;
}

.remove-btn:hover {
    opacity: 1;
}

.empty-state {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 30px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
}

.counter-badge {
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.item-content {
    display: flex;
    align-items: start;
    gap: 10px;
}

.item-text {
    flex: 1;
    min-width: 0;
}

.item-controls {
    display: flex;
    align-items: start;
    gap: 8px;
    flex-shrink: 0;
}

.status-completed { background-color: #d4edda !important; border-color: #c3e6cb !important; }
.status-in_progress { background-color: #cce7ff !important; border-color: #b3d9ff !important; }
.status-on_hold { background-color: #fff3cd !important; border-color: #ffecb5 !important; }
.status-not_started { background-color: #e2e3e5 !important; border-color: #d1d3d4 !important; }
.status-cancelled { background-color: #f8d7da !important; border-color: #f5c6cb !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Status choices with their properties for admin items
const adminStatusChoices = [
    {value: 'completed', label: 'Completed', color: 'success'},
    {value: 'in_progress', label: 'In Progress', color: 'primary'},
    {value: 'on_hold', label: 'On Hold', color: 'warning'},
    {value: 'not_started', label: 'Not Started', color: 'secondary'},
    {value: 'cancelled', label: 'Cancelled', color: 'danger'}
];

// Global counters for each admin section
const adminCounters = {
    admin_highlights: 0,
    admin_challenges: 0,
    admin_strategies: 0
};

// Initialize form on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeAdminForm();
});

function initializeAdminForm() {
    // Initialize each admin section with existing data or empty state
    const sections = ['admin_highlights', 'admin_challenges', 'admin_strategies'];
    
    sections.forEach(section => {
        const container = document.getElementById(section + '-container');
        
        // Try to get existing data for editing
        const existingData = getAdminExistingData(section);
        
        if (existingData && existingData.length > 0) {
            // Populate with existing data
            existingData.forEach(item => {
                const text = typeof item === 'object' ? item.text : item;
                const status = typeof item === 'object' ? item.status : getAdminDefaultStatus(section);
                addAdminItem(section, text, status);
            });
        } else {
            // Show empty state
            showAdminEmptyState(section);
        }
    });
}

function getAdminExistingData(section) {
    // For editing mode, get data from the model
    {% if object %}
        const data = {
            admin_highlights: {{ object.get_admin_highlights_list|safe }},
            admin_challenges: {{ object.get_admin_challenges_list|safe }},
            admin_strategies: {{ object.get_admin_strategies_list|safe }}
        };
        return data[section] || [];
    {% else %}
        return [];
    {% endif %}
}

function getAdminDefaultStatus(section) {
    // Get default status for admin section
    const defaults = {
        admin_highlights: 'completed',
        admin_challenges: 'on_hold',
        admin_strategies: 'not_started'
    };
    return defaults[section] || 'not_started';
}

function createAdminStatusSelect(section, index, selectedStatus = null) {
    const defaultStatus = selectedStatus || getAdminDefaultStatus(section);
    
    let options = '';
    adminStatusChoices.forEach(choice => {
        const selected = choice.value === defaultStatus ? 'selected' : '';
        options += `<option value="${choice.value}" ${selected}>${choice.label}</option>`;
    });
    
    return `<select name="${section}_status_${index}" class="form-select status-select" onchange="updateAdminItemStyle(this)">
                ${options}
            </select>`;
}

function addAdminItem(section, value = '', status = null) {
    const container = document.getElementById(section + '-container');
    const index = adminCounters[section];
    const defaultStatus = status || getAdminDefaultStatus(section);
    
    // Remove empty state if it exists
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    // Create the dynamic item
    const itemDiv = document.createElement('div');
    itemDiv.className = `dynamic-item status-${defaultStatus}`;
    itemDiv.innerHTML = `
        <div class="item-content">
            <div class="counter-badge">${index + 1}</div>
            <div class="item-text">
                <textarea 
                    name="${section}_${index}" 
                    class="form-control" 
                    placeholder="Enter ${section.replace('admin_', '').replace('_', ' ')} item for top management..."
                    rows="2"
                >${value}</textarea>
            </div>
            <div class="item-controls">
                ${createAdminStatusSelect(section, index, defaultStatus)}
                <button type="button" class="btn btn-outline-danger btn-sm remove-btn" 
                        onclick="removeAdminItem(this, '${section}')" title="Remove item">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(itemDiv);
    adminCounters[section]++;
    
    // Focus on the new textarea if it's empty
    const textarea = itemDiv.querySelector('textarea');
    if (!value) {
        textarea.focus();
    }
    
    // Auto-resize functionality
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    
    // Trigger auto-resize for existing content
    if (value) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
}

function updateAdminItemStyle(selectElement) {
    const itemDiv = selectElement.closest('.dynamic-item');
    const newStatus = selectElement.value;
    
    // Remove all status classes
    adminStatusChoices.forEach(choice => {
        itemDiv.classList.remove(`status-${choice.value}`);
    });
    
    // Add new status class
    itemDiv.classList.add(`status-${newStatus}`);
}

function removeAdminItem(button, section) {
    const itemDiv = button.closest('.dynamic-item');
    const container = document.getElementById(section + '-container');
    
    itemDiv.remove();
    
    // Renumber remaining items
    renumberAdminItems(section);
    
    // Show empty state if no items remain
    const remainingItems = container.querySelectorAll('.dynamic-item');
    if (remainingItems.length === 0) {
        showAdminEmptyState(section);
    }
}

function renumberAdminItems(section) {
    const container = document.getElementById(section + '-container');
    const items = container.querySelectorAll('.dynamic-item');
    
    items.forEach((item, index) => {
        const textarea = item.querySelector('textarea');
        const statusSelect = item.querySelector('select');
        const counter = item.querySelector('.counter-badge');
        
        // Update name attributes
        textarea.name = `${section}_${index}`;
        statusSelect.name = `${section}_status_${index}`;
        
        // Update counter display
        counter.textContent = index + 1;
    });
    
    // Update global counter
    adminCounters[section] = items.length;
}

function showAdminEmptyState(section) {
    const container = document.getElementById(section + '-container');
    
    // Don't show empty state if there are items
    if (container.querySelectorAll('.dynamic-item').length > 0) {
        return;
    }
    
    const sectionName = section.replace('admin_', '').replace('_', ' ');
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.innerHTML = `
        <i class="fas fa-plus-circle fa-2x mb-3" style="opacity: 0.5;"></i><br>
        No ${sectionName} added yet<br>
        <small>Click "Add ${sectionName.replace(/\b\w/g, l => l.toUpperCase())}" to get started</small>
    `;
    
    container.appendChild(emptyDiv);
}
</script>
{% endblock %}
