{% extends 'journal/base.html' %}
{% load journal_tags %}

{% block title %}Top Management Tagging - BR Journal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tags text-warning"></i>
        Top Management Tagging
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'journal:topman_report_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Reports
        </a>
    </div>
</div>

<!-- Week Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-week"></i> Select Week</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="{{ week_form.week_start.id_for_label }}" class="form-label">Week Start</label>
                        {{ week_form.week_start }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ week_form.week_end.id_for_label }}" class="form-label">Week End</label>
                        {{ week_form.week_end }}
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Week
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card {% if created_report %}border-success{% endif %}">
            <div class="card-header {% if created_report %}bg-success text-white{% endif %}">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt"></i>
                    {{ report.title }}
                    {% if created_report %}
                        <span class="badge bg-light text-success ms-2">New Report Created</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-2">
                            <strong>Period:</strong> {{ week_start|date:"F d" }} - {{ week_end|date:"F d, Y" }}
                        </p>
                        <p class="mb-2">
                            <strong>Journal Entries:</strong> {{ journal_entries.count }} entries from {{ journal_entries|regroup_by:"department.name"|length }} departments
                        </p>
                        <p class="mb-0">
                            <strong>Tagged Items:</strong> <span id="tagged-count">{{ report.tagged_items.count }}</span> items currently tagged
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'journal:topman_report_detail' report.pk %}" class="btn btn-success">
                            <i class="fas fa-eye"></i> View Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Journal Entries for Tagging -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-journal-whills"></i> 
                    Journal Entries - {{ week_start|date:"M d" }} to {{ week_end|date:"M d, Y" }}
                </h5>
            </div>
            <div class="card-body">
                {% if journal_entries %}
                    {% regroup journal_entries by department as department_groups %}
                    {% for department_group in department_groups %}
                        <div class="department-section mb-4">
                            <h4 class="mb-3">
                                <i class="fas fa-building text-primary"></i>
                                {{ department_group.grouper.name }}
                                <span class="badge bg-primary ms-2">{{ department_group.list|length }} entries</span>
                            </h4>
                            
                            {% for journal in department_group.list %}
                                <div class="journal-entry-card mb-4 border rounded p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="mb-1">
                                                <i class="fas fa-user"></i>
                                                {{ journal.author.get_full_name|default:journal.author.username }}
                                            </h5>
                                            <p class="text-muted mb-0">{{ journal.date_from }} to {{ journal.date_to }}</p>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">
                                                Created: {{ journal.created_at|date:"M d, Y" }}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Journal Sections -->
                                    <div class="journal-sections">
                                        <!-- Highlights -->
                                        {% if journal.get_highlights_list %}
                                            <div class="section mb-3">
                                                <h6 class="text-warning">
                                                    <i class="fas fa-star"></i> Highlights
                                                </h6>
                                                {% for highlight in journal.get_highlights_list %}
                                                    <div class="item-row d-flex align-items-start mb-2 p-2 rounded {% if journal.id|add:0|add:'highlights'|add:forloop.counter0 in tagged_items %}bg-success bg-opacity-10{% endif %}" 
                                                         data-journal-id="{{ journal.id }}" data-section="highlights" data-item-index="{{ forloop.counter0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-start">
                                                                <span class="badge bg-{{ highlight.status|get_status_color }} me-2">
                                                                    <i class="fas fa-{{ highlight.status|get_status_icon }}"></i>
                                                                    {{ highlight.status|get_status_display }}
                                                                </span>
                                                                <div>{{ highlight.text }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ms-2">
                                                            <button type="button" 
                                                                    class="btn btn-sm toggle-tag-btn {% if journal.id|stringformat:'s'|add:',highlights,'|add:forloop.counter0|stringformat:'s' in tagged_items|join:',' %}btn-success{% else %}btn-outline-primary{% endif %}"
                                                                    data-journal-id="{{ journal.id }}" 
                                                                    data-section="highlights" 
                                                                    data-item-index="{{ forloop.counter0 }}"
                                                                    data-report-id="{{ report.id }}"
                                                                    title="{% if journal.id|stringformat:'s'|add:',highlights,'|add:forloop.counter0|stringformat:'s' in tagged_items|join:',' %}Remove from Top Management{% else %}Tag for Top Management{% endif %}">
                                                                <i class="fas fa-{% if journal.id|stringformat:'s'|add:',highlights,'|add:forloop.counter0|stringformat:'s' in tagged_items|join:',' %}check{% else %}tag{% endif %}"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Pendings -->
                                        {% if journal.get_pendings_list %}
                                            <div class="section mb-3">
                                                <h6 class="text-info">
                                                    <i class="fas fa-clock"></i> Pendings
                                                </h6>
                                                {% for pending in journal.get_pendings_list %}
                                                    <div class="item-row d-flex align-items-start mb-2 p-2 rounded" 
                                                         data-journal-id="{{ journal.id }}" data-section="pendings" data-item-index="{{ forloop.counter0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-start">
                                                                <span class="badge bg-{{ pending.status|get_status_color }} me-2">
                                                                    <i class="fas fa-{{ pending.status|get_status_icon }}"></i>
                                                                    {{ pending.status|get_status_display }}
                                                                </span>
                                                                <div>{{ pending.text }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ms-2">
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-primary toggle-tag-btn"
                                                                    data-journal-id="{{ journal.id }}" 
                                                                    data-section="pendings" 
                                                                    data-item-index="{{ forloop.counter0 }}"
                                                                    data-report-id="{{ report.id }}"
                                                                    title="Tag for Top Management">
                                                                <i class="fas fa-tag"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Challenges -->
                                        {% if journal.get_challenges_list %}
                                            <div class="section mb-3">
                                                <h6 class="text-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> Challenges
                                                </h6>
                                                {% for challenge in journal.get_challenges_list %}
                                                    <div class="item-row d-flex align-items-start mb-2 p-2 rounded" 
                                                         data-journal-id="{{ journal.id }}" data-section="challenges" data-item-index="{{ forloop.counter0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-start">
                                                                <span class="badge bg-{{ challenge.status|get_status_color }} me-2">
                                                                    <i class="fas fa-{{ challenge.status|get_status_icon }}"></i>
                                                                    {{ challenge.status|get_status_display }}
                                                                </span>
                                                                <div>{{ challenge.text }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ms-2">
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-primary toggle-tag-btn"
                                                                    data-journal-id="{{ journal.id }}" 
                                                                    data-section="challenges" 
                                                                    data-item-index="{{ forloop.counter0 }}"
                                                                    data-report-id="{{ report.id }}"
                                                                    title="Tag for Top Management">
                                                                <i class="fas fa-tag"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Personal Updates -->
                                        {% if journal.get_personal_updates_list %}
                                            <div class="section mb-3">
                                                <h6 class="text-success">
                                                    <i class="fas fa-user"></i> Personal Updates
                                                </h6>
                                                {% for update in journal.get_personal_updates_list %}
                                                    <div class="item-row d-flex align-items-start mb-2 p-2 rounded" 
                                                         data-journal-id="{{ journal.id }}" data-section="personal_updates" data-item-index="{{ forloop.counter0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-start">
                                                                <span class="badge bg-{{ update.status|get_status_color }} me-2">
                                                                    <i class="fas fa-{{ update.status|get_status_icon }}"></i>
                                                                    {{ update.status|get_status_display }}
                                                                </span>
                                                                <div>{{ update.text }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ms-2">
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-primary toggle-tag-btn"
                                                                    data-journal-id="{{ journal.id }}" 
                                                                    data-section="personal_updates" 
                                                                    data-item-index="{{ forloop.counter0 }}"
                                                                    data-report-id="{{ report.id }}"
                                                                    title="Tag for Top Management">
                                                                <i class="fas fa-tag"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Strategies -->
                                        {% if journal.get_strategies_list %}
                                            <div class="section mb-3">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-lightbulb"></i> Strategies
                                                </h6>
                                                {% for strategy in journal.get_strategies_list %}
                                                    <div class="item-row d-flex align-items-start mb-2 p-2 rounded" 
                                                         data-journal-id="{{ journal.id }}" data-section="strategies" data-item-index="{{ forloop.counter0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-start">
                                                                <span class="badge bg-{{ strategy.status|get_status_color }} me-2">
                                                                    <i class="fas fa-{{ strategy.status|get_status_icon }}"></i>
                                                                    {{ strategy.status|get_status_display }}
                                                                </span>
                                                                <div>{{ strategy.text }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ms-2">
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-primary toggle-tag-btn"
                                                                    data-journal-id="{{ journal.id }}" 
                                                                    data-section="strategies" 
                                                                    data-item-index="{{ forloop.counter0 }}"
                                                                    data-report-id="{{ report.id }}"
                                                                    title="Tag for Top Management">
                                                                <i class="fas fa-tag"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- No Entries State -->
                    <div class="text-center py-5">
                        <i class="fas fa-journal-whills fa-3x text-muted mb-3"></i>
                        <h4>No Journal Entries Found</h4>
                        <p class="text-muted">No journal entries found for the selected week period.</p>
                        <p class="text-muted">{{ week_start|date:"F d" }} - {{ week_end|date:"F d, Y" }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Tagging Modal -->
<div class="modal fade" id="taggingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tags"></i> Tag for Top Management
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="tagging-form">
                    <div class="mb-3">
                        <label class="form-label">Priority Level</label>
                        <select class="form-select" id="priority-select">
                            <option value="high">High Priority</option>
                            <option value="medium" selected>Medium Priority</option>
                            <option value="low">Low Priority</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Admin Note (Optional)</label>
                        <textarea class="form-control" id="admin-note" rows="3" 
                                  placeholder="Why is this item important for top management?"></textarea>
                    </div>
                    <div class="mb-3">
                        <strong>Item Preview:</strong>
                        <div class="p-2 bg-light rounded" id="item-preview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-tag">
                    <i class="fas fa-tag"></i> Tag Item
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taggingModal = new bootstrap.Modal(document.getElementById('taggingModal'));
    let currentTagData = null;
    
    // Handle tag button clicks
    document.querySelectorAll('.toggle-tag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const journalId = this.dataset.journalId;
            const section = this.dataset.section;
            const itemIndex = this.dataset.itemIndex;
            const reportId = this.dataset.reportId;
            
            // Check if already tagged (success class)
            if (this.classList.contains('btn-success')) {
                // Untag the item
                untagItem(journalId, section, itemIndex, reportId, this);
            } else {
                // Show tagging modal
                currentTagData = {
                    journalId: journalId,
                    section: section,
                    itemIndex: itemIndex,
                    reportId: reportId,
                    button: this
                };
                
                // Get item preview text
                const itemRow = this.closest('.item-row');
                const itemText = itemRow.querySelector('div > div:last-child').textContent.trim();
                document.getElementById('item-preview').textContent = itemText;
                
                // Reset form
                document.getElementById('priority-select').value = 'medium';
                document.getElementById('admin-note').value = '';
                
                taggingModal.show();
            }
        });
    });
    
    // Handle confirm tag button
    document.getElementById('confirm-tag').addEventListener('click', function() {
        if (currentTagData) {
            const priority = document.getElementById('priority-select').value;
            const adminNote = document.getElementById('admin-note').value;
            
            tagItem(currentTagData, priority, adminNote);
            taggingModal.hide();
        }
    });
    
    function tagItem(data, priority, adminNote) {
        const formData = new FormData();
        formData.append('journal_id', data.journalId);
        formData.append('section', data.section);
        formData.append('item_index', data.itemIndex);
        formData.append('report_id', data.reportId);
        formData.append('action', 'tag');
        formData.append('priority', priority);
        formData.append('admin_note', adminNote);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "journal:ajax_tag_item" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update button appearance
                data.button.classList.remove('btn-outline-primary');
                data.button.classList.add('btn-success');
                data.button.innerHTML = '<i class="fas fa-check"></i>';
                data.button.title = 'Remove from Top Management';
                
                // Update item row background
                const itemRow = data.button.closest('.item-row');
                itemRow.classList.add('bg-success', 'bg-opacity-10');
                
                // Update tagged count
                const taggedCount = document.getElementById('tagged-count');
                const currentCount = parseInt(taggedCount.textContent);
                taggedCount.textContent = currentCount + 1;
                
                // Show success message
                showAlert('Item tagged successfully!', 'success');
            } else {
                showAlert('Error tagging item: ' + result.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Network error occurred', 'danger');
            console.error('Error:', error);
        });
    }
    
    function untagItem(journalId, section, itemIndex, reportId, button) {
        const formData = new FormData();
        formData.append('journal_id', journalId);
        formData.append('section', section);
        formData.append('item_index', itemIndex);
        formData.append('report_id', reportId);
        formData.append('action', 'untag');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "journal:ajax_tag_item" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update button appearance
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
                button.innerHTML = '<i class="fas fa-tag"></i>';
                button.title = 'Tag for Top Management';
                
                // Update item row background
                const itemRow = button.closest('.item-row');
                itemRow.classList.remove('bg-success', 'bg-opacity-10');
                
                // Update tagged count
                const taggedCount = document.getElementById('tagged-count');
                const currentCount = parseInt(taggedCount.textContent);
                taggedCount.textContent = currentCount - 1;
                
                // Show success message
                showAlert('Item untagged successfully!', 'warning');
            } else {
                showAlert('Error untagging item: ' + result.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Network error occurred', 'danger');
            console.error('Error:', error);
        });
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}
