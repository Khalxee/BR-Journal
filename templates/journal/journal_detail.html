{% extends 'journal/base.html' %}
{% load journal_tags %}

{% block title %}{{ journal.department.name }} Entry - BR Journal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-book"></i>
        {{ journal.department.name }} - {{ journal.date_from }} to {{ journal.date_to }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if journal.author == request.user %}
            <a href="{% url 'journal:update' journal.pk %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-edit"></i> Edit
            </a>
        {% endif %}
        <a href="{% url 'journal:list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Main Content -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-user"></i>
                            {{ journal.author.get_full_name|default:journal.author.username }}
                        </h5>
                        <p class="text-muted mb-0">
                            <i class="fas fa-building"></i> {{ journal.department.name }}
                        </p>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">
                            Created: {{ journal.created_at|date:"M d, Y H:i" }}<br>
                            {% if journal.updated_at != journal.created_at %}
                                Updated: {{ journal.updated_at|date:"M d, Y H:i" }}
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Highlights -->
                {% if journal.get_highlights_list %}
                    <div class="mb-4">
                        <h5 class="text-warning">
                            <i class="fas fa-star"></i> Highlights
                            <span class="badge bg-warning text-dark ms-2">{{ journal.get_highlights_list|length }}</span>
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for highlight in journal.get_highlights_list %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>{{ highlight.text|linebreaks }}</div>
                                            </div>
                                        </div>
                                        <span class="badge bg-{{ highlight.status|get_status_color }} ms-2">
                                            <i class="fas fa-{{ highlight.status|get_status_icon }} me-1"></i>
                                            {{ highlight.status|get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Pendings -->
                {% if journal.get_pendings_list %}
                    <div class="mb-4">
                        <h5 class="text-info">
                            <i class="fas fa-clock"></i> Pendings
                            <span class="badge bg-info ms-2">{{ journal.get_pendings_list|length }}</span>
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for pending in journal.get_pendings_list %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-hourglass-half text-info me-2 mt-1"></i>
                                                <div>{{ pending.text|linebreaks }}</div>
                                            </div>
                                        </div>
                                        <span class="badge bg-{{ pending.status|get_status_color }} ms-2">
                                            <i class="fas fa-{{ pending.status|get_status_icon }} me-1"></i>
                                            {{ pending.status|get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Challenges -->
                {% if journal.get_challenges_list %}
                    <div class="mb-4">
                        <h5 class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Challenges
                            <span class="badge bg-danger ms-2">{{ journal.get_challenges_list|length }}</span>
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for challenge in journal.get_challenges_list %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-times-circle text-danger me-2 mt-1"></i>
                                                <div>{{ challenge.text|linebreaks }}</div>
                                            </div>
                                        </div>
                                        <span class="badge bg-{{ challenge.status|get_status_color }} ms-2">
                                            <i class="fas fa-{{ challenge.status|get_status_icon }} me-1"></i>
                                            {{ challenge.status|get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Personal Updates -->
                {% if journal.get_personal_updates_list %}
                    <div class="mb-4">
                        <h5 class="text-success">
                            <i class="fas fa-user"></i> Personal Updates
                            <span class="badge bg-success ms-2">{{ journal.get_personal_updates_list|length }}</span>
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for update in journal.get_personal_updates_list %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-user-graduate text-success me-2 mt-1"></i>
                                                <div>{{ update.text|linebreaks }}</div>
                                            </div>
                                        </div>
                                        <span class="badge bg-{{ update.status|get_status_color }} ms-2">
                                            <i class="fas fa-{{ update.status|get_status_icon }} me-1"></i>
                                            {{ update.status|get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Strategies -->
                {% if journal.get_strategies_list %}
                    <div class="mb-4">
                        <h5 class="text-primary">
                            <i class="fas fa-lightbulb"></i> Strategies
                            <span class="badge bg-primary ms-2">{{ journal.get_strategies_list|length }}</span>
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for strategy in journal.get_strategies_list %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-lightbulb text-primary me-2 mt-1"></i>
                                                <div>{{ strategy.text|linebreaks }}</div>
                                            </div>
                                        </div>
                                        <span class="badge bg-{{ strategy.status|get_status_color }} ms-2">
                                            <i class="fas fa-{{ strategy.status|get_status_icon }} me-1"></i>
                                            {{ strategy.status|get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Sidebar with metadata and comments -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Entry Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-5">Author:</dt>
                    <dd class="col-7">{{ journal.author.get_full_name|default:journal.author.username }}</dd>
                    
                    <dt class="col-5">Department:</dt>
                    <dd class="col-7">{{ journal.department.name }}</dd>
                    
                    <dt class="col-5">Period:</dt>
                    <dd class="col-7">{{ journal.date_from }} to {{ journal.date_to }}</dd>
                    
                    <dt class="col-5">Total Items:</dt>
                    <dd class="col-7">
                        <span class="badge bg-secondary">
                            {{ journal.get_highlights_list|length|add:journal.get_pendings_list|length|add:journal.get_challenges_list|length|add:journal.get_personal_updates_list|length|add:journal.get_strategies_list|length }}
                        </span>
                    </dd>
                    
                    <dt class="col-5">Created:</dt>
                    <dd class="col-7">{{ journal.created_at|date:"M d, Y H:i" }}</dd>
                    
                    {% if journal.updated_at != journal.created_at %}
                        <dt class="col-5">Updated:</dt>
                        <dd class="col-7">{{ journal.updated_at|date:"M d, Y H:i" }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Status Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Status Summary</h5>
            </div>
            <div class="card-body">
                {% get_status_summary journal as status_summary %}
                <div class="row text-center g-2">
                    <div class="col-6">
                        <div class="p-3 bg-success bg-opacity-10 rounded">
                            <i class="fas fa-check-circle text-success fa-lg"></i>
                            <div class="fw-bold fs-4">{{ status_summary.completed }}</div>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-primary bg-opacity-10 rounded">
                            <i class="fas fa-clock text-primary fa-lg"></i>
                            <div class="fw-bold fs-4">{{ status_summary.in_progress }}</div>
                            <small class="text-muted">In Progress</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-warning bg-opacity-10 rounded">
                            <i class="fas fa-pause-circle text-warning fa-lg"></i>
                            <div class="fw-bold fs-4">{{ status_summary.on_hold }}</div>
                            <small class="text-muted">On Hold</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-secondary bg-opacity-10 rounded">
                            <i class="fas fa-circle text-secondary fa-lg"></i>
                            <div class="fw-bold fs-4">{{ status_summary.not_started }}</div>
                            <small class="text-muted">Not Started</small>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="p-2 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Total Items:</strong></span>
                                <span class="badge bg-dark fs-6">{{ status_summary.total }}</span>
                            </div>
                            {% if status_summary.cancelled > 0 %}
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <span class="text-muted">Cancelled:</span>
                                    <span class="badge bg-danger">{{ status_summary.cancelled }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-comments"></i> Comments ({{ comments.count }})
                </h5>
            </div>
            <div class="card-body">
                <!-- Add Comment Form -->
                <form id="comment-form" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ comment_form.content }}
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Add Comment
                    </button>
                </form>
                
                <!-- Comments List -->
                <div id="comments-list">
                    {% for comment in comments %}
                        <div class="comment mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                                <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                            </div>
                            <p class="mb-0 mt-1">{{ comment.content|linebreaks }}</p>
                        </div>
                    {% empty %}
                        <p class="text-muted text-center py-3" id="no-comments">No comments yet. Be the first to comment!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    fetch('{% url "journal:add_comment" journal.pk %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear form
            form.reset();
            
            // Hide "no comments" message
            const noCommentsMsg = document.getElementById('no-comments');
            if (noCommentsMsg) {
                noCommentsMsg.style.display = 'none';
            }
            
            // Add new comment to list
            const commentsList = document.getElementById('comments-list');
            const commentHtml = `
                <div class="comment mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${data.comment.author}</strong>
                        <small class="text-muted">${data.comment.created_at}</small>
                    </div>
                    <p class="mb-0 mt-1">${data.comment.content.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            commentsList.insertAdjacentHTML('beforeend', commentHtml);
        } else {
            alert('Error adding comment. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding comment. Please try again.');
    });
});
</script>
{% endblock %}
